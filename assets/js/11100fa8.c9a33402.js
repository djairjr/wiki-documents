"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[110],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>f});var o=n(67294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,o,a=function(e,t){if(null==e)return{};var n,o,a={},r=Object.keys(e);for(o=0;o<r.length;o++)n=r[o],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(o=0;o<r.length;o++)n=r[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var s=o.createContext({}),p=function(e){var t=o.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},c=function(e){var t=p(e.components);return o.createElement(s.Provider,{value:t},e.children)},u="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},m=o.forwardRef((function(e,t){var n=e.components,a=e.mdxType,r=e.originalType,s=e.parentName,c=i(e,["components","mdxType","originalType","parentName"]),u=p(n),m=a,f=u["".concat(s,".").concat(m)]||u[m]||d[m]||r;return n?o.createElement(f,l(l({ref:t},c),{},{components:n})):o.createElement(f,l({ref:t},c))}));function f(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var r=n.length,l=new Array(r);l[0]=m;var i={};for(var s in t)hasOwnProperty.call(t,s)&&(i[s]=t[s]);i.originalType=e,i[u]="string"==typeof e?e:a,l[1]=i;for(var p=2;p<r;p++)l[p]=n[p];return o.createElement.apply(null,l)}return o.createElement.apply(null,n)}m.displayName="MDXCreateElement"},85162:(e,t,n)=>{n.d(t,{Z:()=>l});var o=n(67294),a=n(86010);const r={tabItem:"tabItem_Ymn6"};function l(e){let{children:t,hidden:n,className:l}=e;return o.createElement("div",{role:"tabpanel",className:(0,a.Z)(r.tabItem,l),hidden:n},t)}},74866:(e,t,n)=>{n.d(t,{Z:()=>_});var o=n(87462),a=n(67294),r=n(86010),l=n(12466),i=n(16550),s=n(91980),p=n(67392),c=n(50012);function u(e){return function(e){return a.Children.map(e,(e=>{if(!e||(0,a.isValidElement)(e)&&function(e){const{props:t}=e;return!!t&&"object"==typeof t&&"value"in t}(e))return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)}))?.filter(Boolean)??[]}(e).map((e=>{let{props:{value:t,label:n,attributes:o,default:a}}=e;return{value:t,label:n,attributes:o,default:a}}))}function d(e){const{values:t,children:n}=e;return(0,a.useMemo)((()=>{const e=t??u(n);return function(e){const t=(0,p.l)(e,((e,t)=>e.value===t.value));if(t.length>0)throw new Error(`Docusaurus error: Duplicate values "${t.map((e=>e.value)).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e}),[t,n])}function m(e){let{value:t,tabValues:n}=e;return n.some((e=>e.value===t))}function f(e){let{queryString:t=!1,groupId:n}=e;const o=(0,i.k6)(),r=function(e){let{queryString:t=!1,groupId:n}=e;if("string"==typeof t)return t;if(!1===t)return null;if(!0===t&&!n)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return n??null}({queryString:t,groupId:n});return[(0,s._X)(r),(0,a.useCallback)((e=>{if(!r)return;const t=new URLSearchParams(o.location.search);t.set(r,e),o.replace({...o.location,search:t.toString()})}),[r,o])]}function h(e){const{defaultValue:t,queryString:n=!1,groupId:o}=e,r=d(e),[l,i]=(0,a.useState)((()=>function(e){let{defaultValue:t,tabValues:n}=e;if(0===n.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(t){if(!m({value:t,tabValues:n}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${t}" but none of its children has the corresponding value. Available values are: ${n.map((e=>e.value)).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return t}const o=n.find((e=>e.default))??n[0];if(!o)throw new Error("Unexpected error: 0 tabValues");return o.value}({defaultValue:t,tabValues:r}))),[s,p]=f({queryString:n,groupId:o}),[u,h]=function(e){let{groupId:t}=e;const n=function(e){return e?`docusaurus.tab.${e}`:null}(t),[o,r]=(0,c.Nk)(n);return[o,(0,a.useCallback)((e=>{n&&r.set(e)}),[n,r])]}({groupId:o}),y=(()=>{const e=s??u;return m({value:e,tabValues:r})?e:null})();(0,a.useLayoutEffect)((()=>{y&&i(y)}),[y]);return{selectedValue:l,selectValue:(0,a.useCallback)((e=>{if(!m({value:e,tabValues:r}))throw new Error(`Can't select invalid tab value=${e}`);i(e),p(e),h(e)}),[p,h,r]),tabValues:r}}var y=n(72389);const g={tabList:"tabList__CuJ",tabItem:"tabItem_LNqP"};function v(e){let{className:t,block:n,selectedValue:i,selectValue:s,tabValues:p}=e;const c=[],{blockElementScrollPositionUntilNextRender:u}=(0,l.o5)(),d=e=>{const t=e.currentTarget,n=c.indexOf(t),o=p[n].value;o!==i&&(u(t),s(o))},m=e=>{let t=null;switch(e.key){case"Enter":d(e);break;case"ArrowRight":{const n=c.indexOf(e.currentTarget)+1;t=c[n]??c[0];break}case"ArrowLeft":{const n=c.indexOf(e.currentTarget)-1;t=c[n]??c[c.length-1];break}}t?.focus()};return a.createElement("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,r.Z)("tabs",{"tabs--block":n},t)},p.map((e=>{let{value:t,label:n,attributes:l}=e;return a.createElement("li",(0,o.Z)({role:"tab",tabIndex:i===t?0:-1,"aria-selected":i===t,key:t,ref:e=>c.push(e),onKeyDown:m,onClick:d},l,{className:(0,r.Z)("tabs__item",g.tabItem,l?.className,{"tabs__item--active":i===t})}),n??t)})))}function b(e){let{lazy:t,children:n,selectedValue:o}=e;const r=(Array.isArray(n)?n:[n]).filter(Boolean);if(t){const e=r.find((e=>e.props.value===o));return e?(0,a.cloneElement)(e,{className:"margin-top--md"}):null}return a.createElement("div",{className:"margin-top--md"},r.map(((e,t)=>(0,a.cloneElement)(e,{key:t,hidden:e.props.value!==o}))))}function k(e){const t=h(e);return a.createElement("div",{className:(0,r.Z)("tabs-container",g.tabList)},a.createElement(v,(0,o.Z)({},e,t)),a.createElement(b,(0,o.Z)({},e,t)))}function _(e){const t=(0,y.Z)();return a.createElement(k,(0,o.Z)({key:String(t)},e))}},19901:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>s,default:()=>f,frontMatter:()=>i,metadata:()=>p,toc:()=>u});var o=n(87462),a=(n(67294),n(3905)),r=n(74866),l=n(85162);const i={},s="PyTorch to TFLite",p={unversionedId:"Topics/TinyML/ModelAssistant/tutorials/export/pytorch_2_tflite",id:"Topics/TinyML/ModelAssistant/tutorials/export/pytorch_2_tflite",title:"PyTorch to TFLite",description:"This chapter will describe how to convert and export PyTorch models to TFLite models.",source:"@site/docs/Topics/TinyML/ModelAssistant/tutorials/export/pytorch_2_tflite.md",sourceDirName:"Topics/TinyML/ModelAssistant/tutorials/export",slug:"/Topics/TinyML/ModelAssistant/tutorials/export/pytorch_2_tflite",permalink:"/Topics/TinyML/ModelAssistant/tutorials/export/pytorch_2_tflite",draft:!1,editUrl:"https://github.com/Seeed-Studio/wiki-documents/blob/docusaurus-version/docs/Topics/TinyML/ModelAssistant/tutorials/export/pytorch_2_tflite.md",tags:[],version:"current",lastUpdatedBy:"Matthew",lastUpdatedAt:1704868800,formattedLastUpdatedAt:"Jan 10, 2024",frontMatter:{},sidebar:"ProductSidebar",previous:{title:"PyTorch to ONNX",permalink:"/Topics/TinyML/ModelAssistant/tutorials/export/pytorch_2_onnx"},next:{title:"Deployment",permalink:"/Topics/TinyML/ModelAssistant/deploy/overview"}},c={},u=[{value:"Preparation",id:"preparation",level:2},{value:"Environment Configuration",id:"environment-configuration",level:3},{value:"Models and Weights",id:"models-and-weights",level:3},{value:"Export Model",id:"export-model",level:2},{value:"TFLite Export Examples",id:"tflite-export-examples",level:3},{value:"Model Validation",id:"model-validation",level:2},{value:"Model Validation Example",id:"model-validation-example",level:3}],d={toc:u},m="wrapper";function f(e){let{components:t,...n}=e;return(0,a.kt)(m,(0,o.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"pytorch-to-tflite"},"PyTorch to TFLite"),(0,a.kt)("p",null,"This chapter will describe how to convert and export PyTorch models to TFLite models."),(0,a.kt)("h2",{id:"preparation"},"Preparation"),(0,a.kt)("h3",{id:"environment-configuration"},"Environment Configuration"),(0,a.kt)("p",null,"As the ",(0,a.kt)("a",{parentName:"p",href:"../../training/overview"},"Training")," step, we recommend you to do it in a ",(0,a.kt)("strong",{parentName:"p"},"virtual environment")," during the model exporting phase. In the ",(0,a.kt)("inlineCode",{parentName:"p"},"sscma")," virtual environment, make sure that the ",(0,a.kt)("a",{parentName:"p",href:"../../../introduction/installation#step-4-install-extra-dependencies-optional"},"Installation - Prerequisites - Install Extra Dependencies")," step has been completed."),(0,a.kt)("admonition",{type:"tip"},(0,a.kt)("p",{parentName:"admonition"},"If you have configured a virtual environment but not activated it, you can activate it with the following command."),(0,a.kt)("pre",{parentName:"admonition"},(0,a.kt)("code",{parentName:"pre",className:"language-sh"},"conda activate sscma\n"))),(0,a.kt)("h3",{id:"models-and-weights"},"Models and Weights"),(0,a.kt)("p",null,"You also need to prepare the PyTorch model and its weights before exporting the model. For the model, you can find it in the ",(0,a.kt)("a",{parentName:"p",href:"../../config"},"Config")," section, we have already preconfigured. For the weights, you can refer to the following steps to get the model weights."),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},"Refer to ",(0,a.kt)("a",{parentName:"p",href:"../../training/overview"},"Training")," section and choose a model, and train to get the model weights.")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},"Or download the ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/Seeed-Studio/ModelAssistant"},"SSCMA")," official pre-trained weights from our ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/Seeed-Studio/ModelAssistantreleases/tag/model_zoo"},"GitHub Releases - Model Zoo"),"."))),(0,a.kt)("admonition",{type:"tip"},(0,a.kt)("p",{parentName:"admonition"},"Export TFLite model requires a training set as a representative dataset, if it not found, the program will download it automatically. However, for some large datasets, this can take a long time, so please be patient.")),(0,a.kt)("h2",{id:"export-model"},"Export Model"),(0,a.kt)("p",null,"For model transformation (convert and export), the relevant commands with some common parameters are listed."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-sh"},'python3 tools/export.py \\\n    "<CONFIG_FILE_PATH>" \\\n    "<CHECKPOINT_FILE_PATH>" \\\n    --target tflite\n')),(0,a.kt)("h3",{id:"tflite-export-examples"},"TFLite Export Examples"),(0,a.kt)("p",null,"Here are some model conversion examples (",(0,a.kt)("inlineCode",{parentName:"p"},"int8")," precision) for reference."),(0,a.kt)(r.Z,{mdxType:"Tabs"},(0,a.kt)(l.Z,{value:"FOMO Model Conversion",label:"FOMO Model Conversion",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-sh"},"python3 tools/export.py \\\n    configs/fomo/fomo_mobnetv2_0.35_x8_abl_coco.py \\\n    \"$(cat work_dirs/fomo_mobnetv2_0.35_x8_abl_coco/last_checkpoint)\" \\\n    --target tflite \\\n    --cfg-options \\\n        data_root='datasets/mask'\n\n"))),(0,a.kt)(l.Z,{value:"PFLD Model Conversion",label:"PFLD Model Conversion",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-sh"},"python3 tools/export.py \\\n    configs/pfld/pfld_mbv2n_112.py \\\n    \"$(cat work_dirs/pfld_mbv2n_112/last_checkpoint)\" \\\n    --target tflite \\\n    --cfg-options \\\n        data_root='datasets/meter'\n"))),(0,a.kt)(l.Z,{value:"PFLD Model Conversio",label:"PFLD Model Conversion",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-sh"},"python3 tools/export.py \\\n    configs/swift_yolo/swift_yolo_tiny_1xb16_300e_coco.py \\\n    \"$(cat work_dirs/swift_yolo_tiny_1xb16_300e_coco/last_checkpoint)\" \\\n    --target tflite\n    --cfg-options \\\n        data_root='datasets/digital_meter'\n")))),(0,a.kt)("h2",{id:"model-validation"},"Model Validation"),(0,a.kt)("p",null,"Since in the process of exporting the model, ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/Seeed-Studio/ModelAssistant"},"SSCMA")," will do some optimization for the model using some tools, such as model pruning, distillation, etc. Although we have tested and evaluated the model weights during the training process, we recommend you to validate the exported model again."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-sh"},'python3 tools/inference.py \\\n    "<CONFIG_FILE_PATH>" \\\n    "<CHECKPOINT_FILE_PATH>" \\\n    --show \\\n    --cfg-options "<CFG_OPTIONS>"\n')),(0,a.kt)("admonition",{type:"tip"},(0,a.kt)("p",{parentName:"admonition"},"For more parameters supported, please refer to the source code ",(0,a.kt)("inlineCode",{parentName:"p"},"tools/inference.py")," or run ",(0,a.kt)("inlineCode",{parentName:"p"},"python3 tools/inference.py --help"),".")),(0,a.kt)("h3",{id:"model-validation-example"},"Model Validation Example"),(0,a.kt)("p",null,"Here are some examples for validating converted model (",(0,a.kt)("inlineCode",{parentName:"p"},"int8")," precision), for reference only."),(0,a.kt)(r.Z,{mdxType:"Tabs"},(0,a.kt)(l.Z,{value:"FOMO Model Validation",label:"FOMO Model Validation",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-sh"},"python3 tools/inference.py \\\n    configs/fomo/fomo_mobnetv2_0.35_x8_abl_coco.py \\\n    \"$(cat work_dirs/fomo_mobnetv2_0.35_x8_abl_coco/last_checkpoint | sed -e 's/.pth/_int8.tflite/g')\" \\\n    --show \\\n    --cfg-options \\\n        data_root='datasets/mask'\n"))),(0,a.kt)(l.Z,{value:"PFLD Model Validation",label:"PFLD Model Validation",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-sh"},"python3 tools/inference.py \\\n    configs/pfld/pfld_mbv2n_112.py \\\n    \"$(cat work_dirs/pfld_mbv2n_112/last_checkpoint | sed -e 's/.pth/_int8.tflite/g')\" \\\n    --show \\\n    --cfg-options \\\n        data_root='datasets/meter'\n"))),(0,a.kt)(l.Z,{value:"SWIFT-YOLO Model Validation",label:"PFLD Model Validation",mdxType:"TabItem"},(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-sh"},"python3 tools/inference.py \\\n    configs/swift_yolo/swift_yolo_tiny_1xb16_300e_coco.py \\\n    \"$(cat work_dirs/swift_yolo_tiny_1xb16_300e_coco/last_checkpoint | sed -e 's/.pth/_int8.tflite/g')\" \\\n    --show \\\n    --cfg-options \\\n        data_root='datasets/digital_meter'\n")))))}f.isMDXComponent=!0}}]);